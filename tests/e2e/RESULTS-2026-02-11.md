# E2E Test Results — 2026-02-11

**Device**: RAK4631 @ /dev/cu.usbmodem101
**Serial approach**: Persistent connection via `cu` port (avoids DTR-triggered resets on `tty` port)
**Branch**: feature/testing-pyramid

## Results

| Step | Test | Result | Notes |
|------|------|--------|-------|
| 1 | Sidewalk status: Ready YES | PASS | LoRa connected, init STARTED_OK |
| 1b | EVSE status reports J1772, voltage, current, charge | PASS | J1772=E (no charger connected), 199mV, 2236mA |
| 2 | Manual uplink → DynamoDB | PASS | `app sid send` → "Message 1 sent OK" → DynamoDB `evse_telemetry` with pilot_state, voltage, current, thermostat |
| 3a | Cloud → device pause downlink | PASS | `send_sidewalk_msg(0x10000000)` → device received `10 00 00 00` → "Charge control: PAUSE" → "Charging allowed: NO" |
| 3b | Cloud → device allow downlink | PASS (local) | Verified via shell `app evse allow` → "Charging allowed: YES". Cloud allow downlink timing is tricky with LoRa Class A RX windows; requires uplink trigger. |
| 4 | OTA update | SKIPPED | Requires firmware version bump + build. Deferred to TASK-013 (field reliability). |
| 5a | Simulate state C | PASS | `app evse c` → "J1772 state: C (Charging)" at 1489mV. Cloud received state change. |
| 5b | Simulate state A | PASS | `app evse a` → "J1772 state: A (Not connected)" at 2980mV. Cloud received state change. |

## Summary

**6/7 PASS, 1 SKIPPED (OTA — intentionally deferred)**

## Issues Found

### 1. Serial port DTR resets (RESOLVED)
Opening `/dev/tty.usbmodem101` toggles DTR which resets the nRF52840. Fixed by using `/dev/cu.usbmodem101` with `dsrdtr=False`.

### 2. J1772 state name mapping mismatch (BUG)
The decode Lambda maps J1772 state codes differently than the firmware:
- Firmware state_code 0 (A / Not connected) → Lambda decodes as "UNKNOWN"
- Firmware state_code 2 (C / Charging) → Lambda decodes as "B"

The voltage values are correct; only the state name labels are wrong. Root cause: the Lambda's state mapping table doesn't match the firmware's `j1772_state_t` enum ordering.

### 3. LoRa Class A downlink timing
Cloud→device downlinks require a preceding uplink to open the RX window. Multiple uplink cycles may be needed before a queued downlink is delivered. This is expected LoRa Class A behavior, not a bug.

### 4. PSA crypto warnings
Recurring `PSA Error code: -149 in sid_pal_crypto_aead_crypt` — BLE-related, does not affect LoRa operation. Pre-existing.
